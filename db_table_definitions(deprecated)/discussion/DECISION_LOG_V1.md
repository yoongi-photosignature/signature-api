# Database Architecture Decision Log

> ⚠️ **Superseded by v2. See DECISION_LOG_V2.md**

> **작성일:** 2025-12-10
> **프로젝트:** PhotoSignature 신규 시스템

PhotoSignature 프로젝트의 데이터베이스 아키텍처 의사결정 과정을 기록합니다.

---

## 1. 프로젝트 배경

### 기존 시스템
- SQL Server 기반 14개 테이블
- 2021년부터 약 2000만 건 매출 데이터 누적
- 테이블 네이밍: `TB_{PREFIX}{NUMBER}` (MST, CAD, SAL, HIS, LOG, EVE, PUS)

### 새 프로젝트 요구사항
- 기존 데이터 이관 없음 (새로 시작)
- 729대 키오스크 (162개 매장 × 약 4.5대)
- 국내/해외 매장 운영
- 팝업 이벤트가 잦고, 이벤트마다 수익 분배/할인 방식이 다름
- 유연한 스키마 필요

---

## 2. NoSQL 선택 이유

### 왜 SQL을 벗어나려 했는가?

| 기존 SQL의 불편함 | 예시 |
|------------------|------|
| 이벤트마다 컬럼 추가 | `COLORW`가 원래 배경색인데 팝업으로 사용 중 |
| 범용 컬럼 남용 | `BIGO1`, `BIGO2`, `BIGO3` |
| 스키마 변경 부담 | 새 이벤트마다 ALTER TABLE |

### NoSQL의 장점
- 이벤트마다 다른 필드 구조 저장 가능
- 스키마 변경 없이 새 데이터 추가
- 중첩 구조 (popup.revenue.storeRate) 자연스럽게 표현

---

## 3. Firestore vs MongoDB 선택

### 초기 고려: Firestore

**장점:**
- Firebase 생태계 통합
- 실시간 동기화 내장
- 서버리스

**탈락 이유:**
| 제약 | 영향 |
|------|------|
| 트랜잭션 500 문서 제한 | 대량 배치 처리 불가 |
| 집계 함수 없음 (SUM, GROUP BY) | 매출 집계 시 전체 읽기 필요 |
| 읽기 과금 ($0.06/10만 건) | 2000만 건 조회 = $12/회 |
| 복합 쿼리 제한 | 인덱스 관리 복잡 |

### 최종 선택: MongoDB Atlas

**선택 이유:**
- 집계 파이프라인 지원 (SUM, GROUP BY 가능)
- 유연한 스키마 + 집계 성능
- 729대 동시 연결 처리 가능 (M10: 1,500 connections)
- 예측 가능한 비용 ($57/월 고정)

---

## 4. 서버리스 vs 전용 클러스터

### MongoDB Atlas Serverless 검토

**장점:**
- 사용량 기반 과금
- 쓰기 위주 패턴에 유리 (월 $5~15 예상)

**탈락 이유:**
| 제약 | 우리 상황 |
|------|----------|
| 최대 500 동시 연결 | 729대 키오스크 → 초과 가능 |
| 콜드 스타트 지연 | 500ms~3초 |

### 최종 선택: M10 Dedicated ($57/월)

- 1,500 연결 지원
- 콜드 스타트 없음 (항상 실행)
- 10GB 저장소 (현재 충분, 부족 시 M20 업그레이드)

---

## 5. 실시간 상태 관리

### MongoDB에 실시간 상태 저장?

**문제점:**
- 729대가 상태 업데이트마다 DB 쓰기
- 불필요한 쓰기 비용
- MongoDB는 실시간 동기화에 최적화되지 않음

### 최종 선택: Firebase Realtime Database 분리

```
MongoDB: 매출, 정산, 팝업 (트랜잭션 데이터)
Firebase RTDB: 온라인 상태, 용지 잔량, 오늘 매출 (실시간)
```

**이유:**
- Firebase RTDB는 실시간 동기화 특화
- 무료 티어로 729대 충분
- WebSocket 기반 자동 연결 상태 감지
- 프론트엔드에서 바로 구독 가능

---

## 6. LOCAL/GLOBAL 구분 제거

### 초기 설계
```javascript
{
  region: "LOCAL",  // 또는 "GLOBAL"
  country: { code: "KOR" }
}
```

### 문제점
- `region`과 `country.code`가 중복 정보
- `LOCAL` = `country.code === "KOR"`

### 최종 결정: country.code만 사용

```javascript
// 국내 조회
{ "country.code": "KOR" }

// 해외 조회
{ "country.code": { $ne: "KOR" } }
```

---

## 7. 환율 처리 방식

### 검토한 옵션

| 방식 | 설명 | 장단점 |
|------|------|--------|
| **방식 1: 저장 시점 환율 고정** | 키오스크가 매출 발생 시 환율 조회하여 저장 | 조회 빠름, 과거 데이터 불변 |
| **방식 2: 조회 시점 계산** | DB에 원본만 저장, 조회 시 환율 적용 | 환율 변경 시 전체 반영 |
| **방식 3: 월말 일괄 정산** | 임시 저장 → 월말 확정 환율 적용 | 회계 정확, 복잡함 |

### 최종 선택: 방식 1 (저장 시점 환율 고정)

**이유:**
- 키오스크가 분산 처리 (729대가 각자 계산)
- DB 일괄 업데이트 불필요
- 조회 시 추가 계산 없음
- 거래 시점 기록 유지 (감사 대응)

**구현:**
```javascript
// 키오스크가 저장 시
{
  amount: 500,           // 원본 (JPY)
  currency: "JPY",
  exchangeRate: 9.12,    // 저장 시점 환율
  amountKRW: 4560        // 계산된 원화
}
```

---

## 8. 환율 키: 국가코드 vs 통화코드

### 검토

| 방식 | 문제점 |
|------|--------|
| 국가코드 (KOR, JPN) | 유로존 국가들은 같은 통화(EUR) 사용 |
| 통화코드 (KRW, JPY) | 환율 API와 1:1 매핑 |

### 최종 선택: 통화코드 (KRW, JPY, USD)

**이유:**
- 외부 환율 API가 통화코드 사용
- 불필요한 국가→통화 매핑 제거
- 유로존 등 예외 처리 불필요

---

## 9. 프레임 정보 관리

### 상황
- 프레임 종류가 매달 추가/삭제됨
- 디자이너가 별도 페이지에서 관리
- Firestore에 프레임 디자인 정보 저장 예정

### 최종 결정: MongoDB에는 ID만 저장

```javascript
// MongoDB sales
{
  product: {
    frameId: "251210_new_frame01",  // Firestore 문서 ID
    frameCategory: "4CUT"
  }
}

// Firestore frames (디자이너 관리)
{
  name: "크리스마스 스페셜",
  bgColor: "#FF0000",
  bgImg: "gs://bucket/..."
}
```

**이유:**
- 프레임 상세 정보 중복 저장 불필요
- 디자이너 변경 사항 자동 반영
- MongoDB는 매출 집계에 집중

---

## 10. 인덱스 전략

### 주요 쿼리 패턴 분석

| 쿼리 | 필터 조건 |
|------|----------|
| 매장별 월매출 | date + store.id |
| 국내/해외 마감 | date + country.code |
| 팝업별 매출 | date + country.code + popup.id |
| 뷰티/AR 매출 | date + product.type |
| 활성 팝업 필터 | popup.isActive |

### 인덱스 설계 (sales만 5개, 전체 15개)

**sales 인덱스:**
```javascript
{ date: 1, "store.id": 1 }
{ date: 1, "country.code": 1 }
{ date: 1, "country.code": 1, "popup.id": 1 }
{ "popup.isActive": 1, "popup.id": 1 }
{ date: 1, "product.type": 1 }
```

**참고:** 전체 인덱스 수는 15개 (sales 7 + stores 2 + devices 2 + popups 4)

### 비용 영향
- 전체 인덱스 15개 ≈ ~3GB 저장 공간
- M10 (10GB)에서 운영 가능
- 추가/삭제 시 비용 없음, 다운타임 없음

---

## 11. 최종 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    729 Kiosk Devices                        │
│         (환율 조회 + 원화 계산 + DB 저장)                     │
└───────────────────────────┬─────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            ▼               ▼               ▼
┌───────────────────┐ ┌───────────┐ ┌─────────────────────────┐
│ Firebase RTDB     │ │  MongoDB  │ │ Firestore               │
│ $0~5/월           │ │  $57/월   │ │ (기존 사용)              │
├───────────────────┤ ├───────────┤ ├─────────────────────────┤
│ • 온라인 상태     │ │ • 매출    │ │ • 프레임 디자인          │
│ • 용지 잔량       │ │ • 정산    │ │ • 디자이너 관리          │
│ • 오늘 매출 캐시  │ │ • 팝업    │ │                         │
└───────────────────┘ └───────────┘ └─────────────────────────┘
```

### 월 예상 비용: ~$60

---

## 12. 향후 고려사항

| 상황 | 대응 |
|------|------|
| 저장소 10GB 초과 | M10 → M20 업그레이드 ($140/월) |
| 해외 키오스크 증가 | Atlas Global Cluster 검토 |
| 복잡한 분석 필요 | BigQuery 연동 검토 |
| 실시간 대시보드 고도화 | Change Streams 활용 |

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2025-12-10 | 초기 의사결정 문서 작성 |
